
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>破译关键渲染路径（翻译） | Lyu Dada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一篇文章在理解的基础上进行的翻译">
<meta property="og:type" content="article">
<meta property="og:title" content="破译关键渲染路径（翻译）">
<meta property="og:url" content="http://yoursite.com/2015/11/12/破译关键渲染路径（翻译）/index.html">
<meta property="og:site_name" content="Lyu Dada">
<meta property="og:description" content="一篇文章在理解的基础上进行的翻译">
<meta property="og:image" content="./1447231291772.png">
<meta property="og:image" content="./1447231979999.png">
<meta property="og:image" content="./1447233476579.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="破译关键渲染路径（翻译）">
<meta name="twitter:description" content="一篇文章在理解的基础上进行的翻译">
  
    <link rel="alternative" href="/atom.xml" title="Lyu Dada" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Lyu Dada</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">to love and get love</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://github.com/fromIRIS">MYGithub</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-破译关键渲染路径（翻译）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/12/破译关键渲染路径（翻译）/" class="article-date">
  <time datetime="2015-11-11T16:20:25.000Z" itemprop="datePublished">2015-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      破译关键渲染路径（翻译）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="破译关键渲染路径（翻译）">破译关键渲染路径（翻译）</h2><p>英文来源：<a href="http://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/" target="_blank" rel="external">http://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/</a><br>参考：<a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/analyzing-crp" target="_blank" rel="external">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/analyzing-crp</a><br><strong>translated by 南洋</strong></p>
<h3 id="前言_By_南洋">前言 By 南洋</h3><p>最近在研究页面性能监控的事情，得知HTML5的 <code>Navigation Timing API</code>可以获取到一系列加载的关键时间节点。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">'use strict'</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.domInteractive: <span class="subst">$&#123;performance.timing.domInteractive&#125;</span>`</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.domContentLoadedEventStart: <span class="subst">$&#123;performance.timing.domContentLoadedEventStart&#125;</span>`</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.domContentLoadedEventEnd: <span class="subst">$&#123;performance.timing.domContentLoadedEventEnd&#125;</span>`</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.domComplete: <span class="subst">$&#123;performance.timing.domComplete&#125;</span>`</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.loadEventStart: <span class="subst">$&#123;performance.timing.loadEventStart&#125;</span>`</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`performance.timing.loadEventEnd: <span class="subst">$&#123;performance.timing.loadEventEnd&#125;</span>`</span>)</span><br></pre></td></tr></table></figure></p>
<p>将这些代码拷贝到console中，就可以看到加载过程中的部分数据，或直接查看<code>performance.timing</code> 我暂时为监控安排的数据为</p>
<ul>
<li>白屏时间</li>
<li>用户可交互时间</li>
<li>总加载时间</li>
<li>首屏时间<br>白屏时间跟总加载时间暂时可以在这个API直接获得，有分歧的是用户可交互时间，不知道怎么通过这个API取得，在阅读了上面这篇文章后就悟了。</li>
</ul>
<p><strong>在文档中只存在异步脚本的不适用</strong><br><code>interactingTime = timing.domContentLoadedEventEnd - timing.navigationStart</code></p>
<p>另外需要提前说明的是：在下文中出现了一张浏览器加载过程中的路径图，上面的的各种英文代表的是document的状态，什么时间点，浏览器完成了什么事，状态就会相应的改变，而下文中经常提到的<code>DOMContentLoaded（DCL）</code>跟<code>window.onload</code>类似，是事件，当document的状态相应变化时，就会触发相应的事件。而图中的<code>performance.timing.domContentLoadedEventStart</code>与<code>performance.timing.domContentLoadedEventEnd</code>之差就代表了<code>DOMContentLoaded</code>事件执行的时间。同理<code>performance.timing.loadEventStart</code>与<code>performance.timing.loadEventEnd</code>之差代表了<code>onload</code>事件执行的时间。</p>
<h3 id="正文开始">正文开始</h3><p>正如steve在先前的文章中提到的，window.onload不是测量网站速度的最好方法。这个方法是最方便的也是最熟悉的，但是这并不能够获得一些现代页面的一些动态速度信息。我们想象用户能察觉到页面的一种表现：页面开始加载后多久后用户能跟页面进行交互？<br>交互的定义取决于你的页面，对于有些页面我们能获得可见的字就算是交互，而对于另外一些页面，写了狠多的js组件去构建UI（类似Gmail）。对于这两种例子，他们有一个共同点，那就是用户必须能看见的这个页面，换句话来讲就是浏览器需要呈现什么东西到屏幕上。<br>带着这个问题我们来探究一下，当第一批内容呈现在现代浏览器上的时候，到底发生了什么事情。</p>
<h3 id="DOM_+_CSSOM_=_Render_Tree">DOM + CSSOM = Render Tree</h3><p>渲染管道的准确时间点和行为当然会取决于解析（parsing）布局（layout）还有一些管道的结合，抛开不同点来讲，为了得到一些可见的东西在屏幕上，所有浏览器必须要构建什么东西到渲染书（render tree）<br><img src="./1447231291772.png" alt="Alt text"><br>HTML文档的解析构建成了DOM树，在平行空间里有一个被遗忘了的兄弟—-CSSOM，CSSOM是有一些样式规则和样式资源所构建的，DOM树和CSSOM结合构成渲染树（render tree）。这时标明了浏览器有足够的信息区形成布局然后绘制在屏幕上，到目前为止，一切顺利。<br>然而，上图的例子是最乐观的，CSSOM和DOMtree相安无事的在两个平行空间里被构建。接下来很不幸的我将介绍我们最爱的朋友—javascript。</p>
<ul>
<li>同步的javascript可以改些文档在任何节点，因此DOMtree 一旦碰上script标签就会停止构建</li>
<li><strong>javascript能查询dom对象的可被计算的样式，这意味着js可以阻塞css</strong></li>
</ul>
<p><img src="./1447231979999.png" alt="Alt text"></p>
<p>不像上面那种DOM和CSSDOM相安无事的个子构建，现在两者潜在地互相牵制：DOMtree无法构建直到javascript被执行，javascript无法执行直到CSSOM是可行的，Yikes。。。</p>
<p>Depending on how this dependency graph is resolved on your pages, which is governed by how, and how many resources you include in that first “critical path” of the page load, the time to first render will vary accordingly. Can we get some metrics, or insights into this process? Turns out, yes we can!</p>
<h3 id="Document_Interactive_&amp;_DOMContentLoaded">Document Interactive &amp; DOMContentLoaded</h3><p>HTML5 定义了一系列浏览器从开始工作请求http到呈现页面必须执行的规则well documented sequence of steps.<br><img src="./1447233476579.png" alt="Alt text"><br><strong>浏览器加载关键路径图</strong><br>特别的，一系列步骤的较后方两个步骤能解决我们最开始提到的问题。在页面最开始的最开始的内容的出现之前，到底发生了什么事。</p>
<ul>
<li>document被标记为interactive状态，当浏览器结束DOMtree的构建，标明，DOMtree准备好了。</li>
<li>一旦任何标有defer的script标签被执行了，浏览器就会触发了DOMContentLoaded事件，这个时候没有样式文件阻塞了脚本的执行（我注：当然这个script标签是在interactive状态之后的，如果没有表有defer的script，一旦document的状态变成interactive，就会触发DOMContentLoaded事件。）</li>
</ul>
<p>如果没有同步的javascript在文档中，那么DOMtree很CSSOM的构建会平行的进行，当我们将javascript请入的时候事情会变的有趣很多。</p>
<p>如果你给一个同步脚本加上<code>defer</code>，那么这个脚本就会解除对DOMtree构建的阻塞，document的<code>interactive</code>状态不会等待脚本的执行就会开启，值得注意的是，这个相同的脚本会在DOMContentLoaded事件触发之前执行。然后脚本开始执行，简而言之，给脚本加<code>defer</code>，脚本不会阻塞<code>document interactive</code>这个状态了，但是依然会组织DCL事件的触发。(自注：defer执行的时间)</p>
<p>如果你给一个同步脚本加上<code>async异步</code>，CSSOM不会阻塞脚本的执行了，最重要的一个区别，DCL事件的触发不需要等待异步脚本的执行！<br>（自注：这就意味着DCL事件的触发不需要等待CSSOM的完成，此时的现象就跟Develop文档里的第一段解释一样了，同样，这个现象也符合文档中没有脚本的情况<a href="https://developer.mozilla.org/en-US/docs/Web/Events/DOMContentLoaded" target="_blank" rel="external">https://developer.mozilla.org/en-US/docs/Web/Events/DOMContentLoaded</a><br><code>The DOMContentLoaded event is fired when the initial HTML document has been completely loaded and parsed, without waiting for stylesheets, images, and subframes to finish loading.</code>）</p>
<p>第一个关键点：默认情况下，javascript会阻塞DOMtree的构建，也许是被CSSOM构建花费时间的阻塞（自注：CSSOM的构建导致javascript的阻塞，从而导致DOMtree的构建）。同步的脚本很坏，但是我们早就知道，让脚本加上<code>defer</code>/<code>async</code>相当于对解析器做了个保证，这些脚本不会重写dom，故而被放行。</p>
<p>第二个关键点： 如果在某种情况下我们必须要等待脚本的执行，我们首先要让CSSOM构建完毕。换句话说，javascript跟css之间有严重的依赖关系。。。。样式在上，脚本在下，现在知道原因了？</p>
<p>好了！理论固然重要，但是这些抽象的知识能帮助我们优化页面速度吗？balabala。。废话。。（理论是基础）</p>
<h3 id="沿着你的页面的关键路劲">沿着你的页面的关键路劲</h3><p>如果不出意外，监控<code>documenr interactive</code>状态，会给我们很好的一个指示：我们是否因为同步的脚本阻塞了DOMtree的构建，有时候测量这个阻塞的行为没有其他办法了，所以监控<code>interactive</code>状态会是一个折中的好办法。</p>
<p>而DCL事件（domContentLoaded）也是个关键的指标，许多著名的库，类似<code>jquery</code>，在触发这个事件后开始执行他们的代码，换句话说，这可能是用户能跟页面交互的一个开始时间节点，而在这个事件中的回调，也是在这个事件触发后发给用户。如果你做对了工作，通过逐步的提高，你可以让页面的速度加快，因此用户可以跟页面交互而浏览器继续加载剩余的资源（img等）。IE团队有一个绝佳的例子演示了DCL与<code>window.onload</code>的不同。<br><a href="http://ie.microsoft.com/testdrive/HTML5/DOMContentLoaded/Default.html" target="_blank" rel="external">http://ie.microsoft.com/testdrive/HTML5/DOMContentLoaded/Default.html</a></p>
<p>完。</p>
<p>—<br>原创文章，转载请注明出处！</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2015/11/12/破译关键渲染路径（翻译）/" data-id="cih0ly1pd00042yjhvzos7tbj" class="article-share-link" data-share="baidu">分享到</a>
      

      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端性能监控/">前端性能监控</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/10/12/attribute与property/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">attribute与property</div>
    </a>
  
</nav>

  
</article>

</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分類</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/html-css/">html&css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/动画库/">动画库</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標簽</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Regexp/">Regexp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html-css/">html&css</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jsLib/">jsLib</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web移动端/">web移动端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端性能监控/">前端性能监控</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂/">杂</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標簽雲</h3>
    <div class="widget tagcloud">
      <a href="/tags/Regexp/" style="font-size: 10px;">Regexp</a><a href="/tags/html-css/" style="font-size: 10px;">html&css</a><a href="/tags/javascript/" style="font-size: 20px;">javascript</a><a href="/tags/js/" style="font-size: 10px;">js</a><a href="/tags/jsLib/" style="font-size: 10px;">jsLib</a><a href="/tags/web移动端/" style="font-size: 10px;">web移动端</a><a href="/tags/前端性能监控/" style="font-size: 10px;">前端性能监控</a><a href="/tags/杂/" style="font-size: 10px;">杂</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">歸檔</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/11/12/破译关键渲染路径（翻译）/">破译关键渲染路径（翻译）</a>
          </li>
        
          <li>
            <a href="/2015/10/12/attribute与property/">attribute与property</a>
          </li>
        
          <li>
            <a href="/2015/10/05/hammer-js/">hammerjs的初次学习</a>
          </li>
        
          <li>
            <a href="/2015/10/05/tween/">tweenMax基础api的逐条随意翻译</a>
          </li>
        
          <li>
            <a href="/2015/09/28/lazyload-js源码学习/">lazyload.js源码学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情鏈接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://xiguabaobao.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Lyu Dada<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com/fromIRIS" class="mobile-nav-link">MYGithub</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回頂部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>window._bd_share_config={"common":{},"share":{"bdCustomStyle":"/css/bdshare.css"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js" type="text/javascript"></script>

</div>
</body>
</html>
